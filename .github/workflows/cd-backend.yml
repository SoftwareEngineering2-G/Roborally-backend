name: Backend CD Pipeline

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  DEPLOY_PATH: /home/${{ secrets.VM_USERNAME }}/roborally-backend

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --no-restore --verbosity normal

  deploy:
    name: Deploy to VM
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Copy repository to VM
        run: |
          echo "üì¶ Syncing repository to VM..."
          ssh ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"
          rsync -avz --delete -e "ssh -i ~/.ssh/id_rsa" \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='bin' \
            --exclude='obj' \
            ./ ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            
            echo "üõë Stopping existing containers..."
            docker-compose down || true
            
            # Backup database if it exists
            if docker ps -a --format '{{.Names}}' | grep -q "roborally_db"; then
              echo "üíæ Creating database backup..."
              docker exec roborally_db pg_dump -U ${{ secrets.POSTGRES_USER }} ${{ secrets.POSTGRES_DB }} > backup_$(date +%Y%m%d_%H%M%S).sql 2>/dev/null || echo "‚ö†Ô∏è  Backup skipped"
            fi
            
            echo "üßπ Cleaning old images..."
            docker image prune -f || true
            
            # Export PostgreSQL credentials for docker-compose
            export POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            export POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            export POSTGRES_DB=${{ secrets.POSTGRES_DB }}
            
            echo "üê≥ Building and starting containers..."
            docker-compose up -d --build
            
            echo "‚è≥ Waiting for services to start..."
            sleep 25
            
            echo "üìä Container status:"
            docker-compose ps
            
            echo "üìã Recent logs:"
            docker-compose logs --tail=40
            
            echo "‚úÖ Deployment completed!"
          ENDSSH

      - name: Health Check
        run: |
          echo "üè• Running health check..."
          sleep 10
          
          max_attempts=12
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            if curl -f http://${{ secrets.VM_HOST }}:5100/health 2>/dev/null; then
              echo "‚úÖ Backend health endpoint responding!"
              exit 0
            elif curl -f http://${{ secrets.VM_HOST }}:5100 2>/dev/null; then
              echo "‚úÖ Backend is responding!"
              exit 0
            fi
            echo "‚è≥ Attempt $attempt/$max_attempts - waiting 10s..."
            sleep 10
            ((attempt++))
          done
          
          echo "‚ö†Ô∏è  Health check timeout - verifying container status..."
          ssh -i ~/.ssh/id_rsa ${{ secrets.VM_USERNAME }}@${{ secrets.VM_HOST }} "cd ${{ env.DEPLOY_PATH }} && docker-compose ps && docker-compose logs --tail=20"
          
          echo "‚ö†Ô∏è  Manual verification may be needed"
          exit 0

      - name: Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "üåê Backend URL: http://${{ secrets.VM_HOST }}:5100"
          else
            echo "‚ùå Deployment failed!"
            exit 1
          fi